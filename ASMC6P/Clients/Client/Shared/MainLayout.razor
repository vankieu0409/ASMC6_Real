@using MudBlazor.Utilities
@inherits LayoutComponentBase
@using ASMC6P.Client.Pages
@using ASMC6P.Shared.Dtos
@using Microsoft.AspNetCore.Components.Authorization
@using MudBlazor

<MudThemeProvider @ref="@_mudThemeProvider" @bind-IsDarkMode="@_isDarkMode" />
<MudDialogProvider />
<MudSnackbarProvider />
<MudLayout>
    <MudAppBar Elevation="24" Color="Color.Primary">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@((e) => DrawerToggle())" />
        <AuthorizeView>
            <Authorized>
               
                <MudSpacer />
                <MudExpansionPanels>
                    <MudIconButton Color="Color.Inherit" Edge="Edge.Start" OnClick="@((e) => ToggleRightDrawer())">
                        <MudAvatar Color="Color.Warning" Image="@userDto.Image"/>
                    </MudIconButton>
                </MudExpansionPanels>
            </Authorized>
            <NotAuthorized>
                <MudSpacer />
                <MudIconButton Icon="@Icons.Material.Outlined.Login" OnClick="Login" Edge="Edge.End">Login</MudIconButton>
            </NotAuthorized>
        </AuthorizeView>
        <MudToggleIconButton Toggled="@_isDarkMode" ToggledChanged="OnToggledChanged"
                             Icon="@Icons.Material.Outlined.LightMode" Color="@Color.Inherit" Title="Default"
                             ToggledIcon="@Icons.Material.Outlined.DarkMode" ToggledColor="@Color.Dark" ToggledTitle="Dark" Edge="Edge.End" />
    </MudAppBar>
    <MudDrawer @bind-Open="_drawerOpen" ClipMode="DrawerClipMode.Never" Breakpoint="Breakpoint.Sm" Elevation="24" Variant="@DrawerVariant.Persistent" OpenMiniOnHover="false">
        <NavMenuCategory/>
    </MudDrawer>
    <MudDrawer @bind-Open="@openEnd" ClipMode="DrawerClipMode.Never" Breakpoint="Breakpoint.Sm" Anchor="Anchor.End" Elevation="24" Variant="@DrawerVariant.Persistent" OpenMiniOnHover="false">
        <MudDrawerHeader>
            <MudText Typo="Typo.h6">Settings</MudText>
        </MudDrawerHeader>
        <MudNavMenu>
            <MudNavLink Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.AccountBox">Profile</MudNavLink>
            @if (@BadgeContent != null)
            {
                <MudBadge Origin="Origin.CenterRight" Content="@BadgeContent" Color="Color.Error" Overlap="false" Dot="false" Bordered="true">
                    <MudNavLink Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.ShoppingCart">Orders  </MudNavLink>
                </MudBadge>
            }
            else
            {
                <MudNavLink Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.ShoppingCart">Orders</MudNavLink>  
            }
            <MudNavLink Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.History">Order History</MudNavLink>
        </MudNavMenu>
    </MudDrawer>
    <MudMainContent>
        <MudContainer>
            @Body
        </MudContainer>
    </MudMainContent>
</MudLayout>
@code {
    UserDto userDto = new UserDto();
    bool _drawerOpen = true;
    bool openEnd = false;
    private bool _isDarkMode = false;
    private MudThemeProvider _mudThemeProvider;
    public int? BadgeContent { get; set; } = 5;

    public void OnToggledChanged(bool toggled)
    {
        // Because variable is not two-way bound, we need to update it ourself
        _isDarkMode = toggled;
    }

    //protected  override async void OnInitialized()
    //{
    //    //userDto = await _localStorage.GetItemAsync<UserDto>("user");
    //}

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        userDto = await _localStorage.GetItemAsync<UserDto>("user");
        if (firstRender)
        {
            _isDarkMode = await _mudThemeProvider.GetSystemPreference();
            StateHasChanged();
        }
    }


    void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }
    void ToggleRightDrawer()
    {
        openEnd = !openEnd;
    }
    private async Task BeginSignOut(MouseEventArgs args)
    {
        var checkLogout = await _authentication.LogoutService();
        if (checkLogout) _navigationManager.NavigateTo("/", true);
        else await _jsRuntime.InvokeVoidAsync("alert", "Đăng không xuất thành công!");

    }
    public void AddBadgeContentValue()
    {
        if(BadgeContent == null)
        {
            BadgeContent = 1;
        }
        else
        {
            BadgeContent += 25;
        }
    }
    void Login()
    {
        _navigationManager.NavigateTo("/login");
    }
}
